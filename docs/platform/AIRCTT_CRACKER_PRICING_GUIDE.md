# AIRCTT 크랙커(Cracker) 쿠폰 — 단가표 & 운영 정책 v1

## 1. 개요

AIRCTT는 **"쿠폰 발행 → 승인 → 게임 스폰 → 유저 획득 → 지갑 → 선물/사용 → 정산"**을 하나로 연결하는 AR/게임 기반 쿠폰 유통 플랫폼입니다.

본 문서는 **크랙커(쿠폰 미디어: 2D/3D/영상)** 제작 단가와 필수 운영 정책을 정의합니다.

---

## 2. 크랙커 제작 단가표

> 매장(발행자)이 쿠폰 발행 시 업로드하는 "쿠폰 디자인/미디어"는 **운영 승인 후** 게임 크랙커로 반영됩니다.

### 2-1. 기본 단가

| 구분 | asset_type 코드 | 설명 | 기본 단가(원/장) |
|------|----------------|------|-----------------|
| 2D 이미지 | `IMAGE_2D` | 정적 이미지 기반 크랙커 | 50원 |
| 3D 모델 | `MODEL_3D` | 3D 드롭 오브젝트 | 80원 |
| 영상형 | `VIDEO` | MP4/WebM 모션 크랙커 | 100원~ |

### 2-2. 이벤트/확장 (별도 견적)

| 확장 | asset_type 코드 | 설명 | 과금 |
|------|----------------|------|------|
| AR 이벤트 | `AR_EVENT` | 모바일 AR 공간 배치/미션 | 별도 |
| 스마트글래스 | `SMARTGLASS` | 글래스 UX/가이드/인터랙션 | 별도 |
| 초지능 아바타 | `AI_AVATAR_EVENT` | 아바타 안내/무대/행사 진행 | 별도 |
| 아바타 행사 | `AVATAR_SHOW` | 무대/댄서/연출형 이벤트 | 별도 |

### 2-3. 발행 비용 산정 예시

- 2D 이미지 1,000장 발행: `50 × 1,000 = 50,000원`
- 3D 모델 500장 발행: `80 × 500 = 40,000원`
- 영상형 200장 발행: `100 × 200 = 20,000원`

---

## 3. 업로드 규격

### 3-1. IMAGE_2D
- 확장자: JPG / PNG / GIF / WebP
- 권장 사이즈: 500×500px 이상 (정사각 권장)
- 투명 PNG 허용
- 최대 용량: 2MB

### 3-2. MODEL_3D
- 포맷: glTF / GLB (권장)
- 폴리곤: 50,000 이하 권장 (모바일 성능)
- 텍스처: 2048×2048 이하
- 최대 용량: 10MB

### 3-3. VIDEO
- 포맷: MP4 / WebM
- 길이: 3~10초 권장
- 해상도: 720p 이상
- 최대 용량: 20MB

---

## 4. 쿠폰 발행 필수 규칙

### 4-1. 자동 쿠폰번호 생성 (필수)

쿠폰 발행 시 아래 값 기반으로 **고유 코드(coupon_code)가 자동 생성**되어 DB에 저장됩니다:

- `store_id` (발행 매장)
- `product_sku` (단일 상품 코드)
- `valid_from` / `valid_to` (유효기간)
- `nonce` (예측 불가능한 난수)

**원칙:** 쿠폰 코드는 예측 불가능해야 하며, DB에 UNIQUE로 저장됩니다.

### 4-2. 단일회사 + 단일상품 정책

본 정책은 **단일회사(store_id)에서 발행한 단일상품(product_sku 1개)에 한정**합니다.

```
coupon_group_key = store_id + ":" + product_sku
```

예시 (아미 빤쭈 매장, 단일상품 PANTS-001):
- 10% 쿠폰 1,000장
- 20% 쿠폰 500장
- 30% 쿠폰 300장
- 50% 쿠폰 100장

→ **같은 유저는 이 중 가장 높은 할인 쿠폰 1장만 보유 가능**

### 4-3. product_sku 입력 규칙

가맹점(사장님)이 쿠폰 발행 시 **직접 입력** (필수):

- 형식: `브랜드-상품명-번호` (예: `PANTS-BASIC-001`, `CU-ONIGIRI-001`)
- 영문 대문자 + 숫자 + 하이픈(-)
- 발행 후 수정 불가

---

## 5. 고객 지갑 저장 정책

### 5-1. 1인 1장 (단일상품 기준)

동일 `coupon_group_key`에 대해 유저 지갑에 **쿠폰 중복 저장 불가**.

- 게임 모션/연출은 항상 발생 (UX 유지)
- 지갑 저장은 정책적으로 제한

DB 제약: `UNIQUE (user_id, coupon_group_key)` on `coupon_issues`

### 5-2. 최고 할인만 유지 (자동 교체)

동일 `coupon_group_key` 쿠폰이 여러 종류일 때:

1. 지갑에는 **가장 높은 혜택 1장만 유지**
2. 더 낮은 혜택 쿠폰은 저장하지 않거나 `REPLACED` 처리

우선순위:
1. 무료쿠폰(FREEBIE) > %할인(PERCENT) > 정액할인(AMOUNT)
2. %할인은 숫자 큰 것 우선 (50% > 30% > 20% > 10%)

---

## 6. 승인(Moderation) 정책

### 6-1. 상태값

| 상태 | 설명 |
|------|------|
| `DRAFT` | 작성 중 |
| `PENDING_APPROVAL` | 승인 대기 |
| `APPROVED` | 승인 완료 → 게임 반영 가능 |
| `REJECTED` | 반려 |

### 6-2. 승인 규칙

- `APPROVED` 상태가 아니면 **지도/게임에 절대 노출 불가**
- 승인 시점에 확정: asset_type, asset_url, 스폰 범위/기간
- 관리자 `/crm/admin/approvals` 에서 처리

---

## 7. 선물하기(Gift) 정책

### 7-1. 기본 방식 (링크 기반)

1. 지갑에서 "선물하기" 버튼 클릭
2. `gift_token` (UUID + 만료시간) 생성
3. 링크 생성: `/gift/{token}`
4. 수신자가 로그인 후 "수락" 버튼으로 이전

### 7-2. 선물 규칙

- 상태가 `active`인 쿠폰만 선물 가능 (`used`, `expired` 불가)
- 1회 전송만 허용
- 수신자도 동일 `coupon_group_key` 정책 적용 (1인 1장 + 최고 할인)
- 수신자가 이미 더 높은 할인 보유 시 → 수락 불가 또는 자동 대체

---

## 8. 게임 크랙커 연동

### 8-1. 스폰 데이터 구조

게임 크랙커에 포함될 최소 필드:

```typescript
{
  coupon_id: string;       // 쿠폰 ID
  store_id: string;        // 매장 ID
  coupon_group_key: string; // 그룹키 (중복 방지)
  display_label: string;   // 표시용 (예: "30% / PANTS-001")
  asset_type: string;      // IMAGE_2D | MODEL_3D | VIDEO
  asset_url: string;       // 에셋 URL
  spawn_no: number;        // 스폰 순번
}
```

### 8-2. 스폰 소스

- 게임 스폰 = `/api/coupons/nearby` 결과를 그대로 사용 (near API 공용)
- 발행 → 게임 반영은 이벤트 체인이 아니라 **near refresh로 자연 반영**

---

## 9. 정산 구조

### 9-1. 기본 정산

- 정산 단위: 월별 (`YYYY-MM`)
- 정산 기준: 쿠폰 사용(REDEEMED) 이벤트
- 수수료: 결제 수수료 3.3% (PG사 협의 후 확정)

### 9-2. 정산 리포트 구조

```
settlements 테이블:
- store_id
- period (예: '2026-02')
- gross_amount (총 거래액)
- fee_amount (수수료)
- net_amount (정산액)
- status: DRAFT | CONFIRMED | PAID
```

---

## 10. 운영 체크리스트 (필수 6단계)

| 단계 | 확인 항목 |
|------|----------|
| 1 | 쿠폰 발행 저장됨 (DB) |
| 2 | 운영 승인 완료됨 (APPROVED) |
| 3 | 지도에 노출됨 (near query) |
| 4 | 게임에 스폰됨 (spawn) |
| 5 | 잡으면 지갑에 반영됨 (acquire) |
| 6 | 지갑 클릭 시 상점/주문 이동됨 (deeplink) |

---

## 변경 이력

| 버전 | 날짜 | 내용 |
|------|------|------|
| v1 | 2026-02-17 | 단가표/발행번호/지갑중복방지/최고혜택유지/선물하기/승인 정책 확정 |
